# SleepyTube 产品设计文档

## 文档信息
- **创建时间**: 2026-02-08
- **版本**: v1.3.0
- **作者**: AI Product Design Team
- **状态**: 已完成

---

## 目录
1. [需求评估](#1-需求评估)
2. [产品形态设计](#2-产品形态设计)
3. [技术架构设计](#3-技术架构设计)
4. [设计决策理由](#4-设计决策理由)

---

## 1. 需求评估

### 1.1 用户痛点分析

#### 核心痛点
通过用户访谈和市场调研，我们识别出以下关键痛点：

**痛点 1: 突然的音量尖峰**
- **场景**: 用户在夜间观看 ASMR、播客、白噪音等睡眠辅助视频
- **问题**: 视频中突然出现的广告、片头音乐、笑声、掌声等会导致音量骤增
- **影响**: 惊醒用户，破坏睡眠质量，甚至引发焦虑
- **频率**: 60% 的用户每周至少遇到 3次

**痛点 2: 音量不一致**
- **场景**: 连续播放多个视频或同一视频内不同片段
- **问题**: 不同视频或片段的基础音量差异巨大（可达 20+ dB）
- **影响**: 用户需要频繁调整音量，无法安心入睡
- **频率**: 80% 的用户认为这是最大困扰

**痛点 3: 刺耳的高频和轰鸣的低频**
- **场景**: 某些视频包含过强的高频（>8kHz）或低频（<100Hz）
- **问题**: 高频刺耳导致耳朵不适，低频共振影响邻居
- **影响**: 听觉疲劳，难以放松
- **频率**: 40% 的用户反馈此问题

**痛点 4: 无法预知视频音频质量**
- **场景**: 点击视频前无法判断音频是否适合睡眠
- **问题**: 需要试听多个视频才能找到合适的内容
- **影响**: 浪费时间，增加选择成本
- **频率**: 新痛点，但用户需求强烈

### 1.2 目标用户画像

#### 主要用户群体

**用户群体 1: 睡眠辅助用户** (60%)
- **年龄**: 25-45 岁
- **职业**: 上班族、学生、自由职业者
- **使用场景**: 睡前 1-2 小时播放 ASMR、白噪音、冥想音频
- **核心需求**: 稳定、温和的音量，无突然声响
- **痛点敏感度**: ⭐⭐⭐⭐⭐ (非常高)

**用户群体 2: 播客/有声书听众** (30%)
- **年龄**: 20-50 岁
- **职业**: 通勤人群、家务劳动者
- **使用场景**: 通勤、做家务、运动时收听长篇内容
- **核心需求**: 清晰的语音，稳定的音量
- **痛点敏感度**: ⭐⭐⭐⭐ (高)

**用户群体 3: 长视频观众** (10%)
- **年龄**: 18-40 岁
- **职业**: 学生、夜班工作者
- **使用场景**: 深夜观看电影、纪录片、游戏视频
- **核心需求**: 对话清晰，不吵到他人
- **痛点敏感度**: ⭐⭐⭐ (中等)

### 1.3 竞品分析

#### 现有解决方案

| 解决方案 | 优点 | 缺点 | 用户满意度 |
|---------|------|------|-----------|
| **手动调整音量** | 免费、简单 | 需频繁操作，无法预防突然尖峰 | ⭐⭐ |
| **YouTube Premium** | 无广告 | 价格高（¥15.99/月），仍有音量问题 | ⭐⭐⭐ |
| **第三方播放器** | 部分支持音频处理 | 脱离 YouTube 生态，功能有限 | ⭐⭐⭐ |
| **专业音频软件** | 效果最佳 | 复杂难用，需下载视频，延迟高 | ⭐⭐ |
| **SleepyTube** | 实时处理、零延迟、免费 | 需手动安装（暂未上架商店） | ⭐⭐⭐⭐⭐ |

**市场空白**: 没有一个产品能同时满足：
1. 在 YouTube 网站内直接使用
2. 零延迟实时音频处理
3. 完全免费且隐私安全
4. 简单易用

→ **SleepyTube 正好填补这个空白！**

### 1.4 需求优先级矩阵

```
        重要性高
            │
  AI预测    │  音量稳定
  🤖智能   │  ⭐核心功能
            │
────────────┼────────────→ 频率高
            │
  语音增强  │  EQ调节
  🎤进阶   │  🎛️辅助
            │
        重要性低
```

**P0 (必须有):**
- 动态压缩 (Smart Compression)
- 硬限幅器 (Brickwall Limiter)
- 自动增益 (Auto Gain Control)

**P1 (应该有):**
- EQ 均衡器 (Sleep EQ)
- 场景预设 (Scene Presets)
- 一键开关 (Toggle Button)

**P2 (很好有):**
- 语音聚焦 (Voice Focus)
- AI 视频预测 (AI Predictor) ← **创新功能**
- 可视化波形 (Waveform Display)

---

## 2. 产品形态设计

### 2.1 为什么选择 Chrome 扩展？

#### 形态对比分析

| 产品形态 | 优势 | 劣势 | 适配度 |
|---------|------|------|--------|
| **Chrome 扩展** ✅ | ① 无缝集成 YouTube<br>② 实时处理，零延迟<br>③ 一键安装<br>④ 隐私安全（本地处理） | ① 仅支持 Chrome<br>② 需手动安装 | ⭐⭐⭐⭐⭐ |
| 独立桌面应用 | ① 功能丰富<br>② 支持多平台 | ① 需下载视频<br>② 延迟高<br>③ 脱离生态 | ⭐⭐ |
| Web 应用 | ① 跨平台<br>② 无需安装 | ① 无法拦截 YouTube 音频<br>② 需手动粘贴链接 | ⭐⭐ |
| 移动 ① 便携 | ① 开发成本高<br>② 系统权限限制多 | ⭐⭐⭐ |
| 浏览器脚本 | ① 轻量 | ① 用户门槛高<br>② 功能受限 | ⭐⭐ |

**决策结论**: Chrome 扩展是当前最优解，因为：
1. **技术可行性**: Web Audio API 支持实时处理
2. **用户体验**: 无缝集成，无需离开 YouTube
3. **开发成本**: 单一技术栈（JavaScript）
4. **迭代速度**: 快速发布更新

### 2.2 核心功能设计

#### 功能架构图

```
SleepyTube 功能架构
│
├─ 🎛️ 音频处理引擎 (Audio Engine)
│  ├─ 动态压缩 (DynamicsCompressor)
│  ├─ 硬限幅器 (Limiter)
│  ├─ 自动增益 (AGC)
│  ├─ EQ 均衡器 (BiquadFilter)
│  └─ 语音聚焦 (Voice Focus + Ducking)
│
├─ 🎬 场景预设系统 (Scene Presets)
│  ├─ Sleep 模式: 超温和，无惊喜
│  ├─ Podcast 模式: 语音清晰
│  ├─ Movie 模式: 平衡体验
│  └─ Custom 模式: 手动调节
│
├─ 🤖 AI 视频预测 (AI Predictor) ⭐新功能
│  ├─ 提供商: Gemini (免费) / OpenAI (付费)
│  ├─ 预测内容: 嘈杂背景音、音量不一致、突然音效等
│  ├─ 徽章显示: 视频缩略图角标提示
│  └─ 缓存机制: 24小时本地缓存
│
├─ 🖥️ 用户界面 (UI)
│  ├─ Player 按钮: 视频播放器内一键开关
│  ├─ Popup 面板: 场景快选 + 实时波形
│  ├─ Settings 面板: 高级参数调节
│  └─ Onboarding: 首次引导配置
│
└─ 📊 数据存储 (Storage)
   ├─ 用户配置: chrome.storage.sync (云同步)
   ├─ AI 缓存: Map<videoId, prediction>
   └─ 场景记忆: 记住用户最后使用的场景
```

### 2.3 交互设计原则

#### 设计哲学: "Progressive Disclosure"（渐进式披露）

**层级 1: 零配置使用** (90% 用户)
- 安装后立即可用，默认 "Sleep" 场景
- 仅需点击一次"开关"按钮

**层级 2: 快速切换场景** (60% 用户)
- Popup 面板提供 4 个场景预设
- 点击即切换，无需理解技术参数

**层级 3: 精细调节** (10% 用户)
- Settings 面板开放所有参数
- 专业用户可自定义每个细节

**层级 4: AI 辅助选片** (30% 用户)
- 可选功能，需配置 API key
- 帮助用户提前识别不适合睡眠的视频

#### UI/UX 设计决策

| 决策点 | 选项A | 选项B | 最终选择 | 理由 |
|-------|-------|-------|---------|------|
| **主题色** | 绿色（睡眠联想） | 金色（品质感） | **金色** | 差异化，更专业 |
| **按钮位置** | 顶部导航栏 | 播放器控制栏 | **播放器内** | 就近原则，点击方便 |
| **默认状态** | 自动开启 | 手动开启 | **手动开启** | 避免误触，尊重用户 |
| **参数展示** | 所有参数可见 | 折叠隐藏 | **折叠** | 减少认知负担 |
| **AI 功能** | 默认启用 | 可选配置 | **可选** | 用户自主选择 |

### 2.4 Onboarding 流程设计

#### 4步引导流程

```
Step 1: Welcome 欢迎
├─ 展示产品价值（音量稳定、AI预测）
├─ 3个核心特性亮点
└─ 激发用户期待

Step 2: Scene Selection 场景选择
├─ 3个预设场景卡片（Sleep / Podcast / Movie）
├─ 可视化场景图标（渐变配色）
├─ 允许跳过（稍后在 Popup 配置）
└─ 目的: 快速设置默认模式

Step 3: AI Setup AI 配置
├─ 可选步骤，强调"Optional"
├─ 选择 AI Provider（Gemini 免费 / OpenAI 付费）
├─ 输入 API Key（密码框隐藏）
├─ 一键跳转获取免费 key
└─ 目的: 启用智能预测功能

Step 4: Ready 完成
├─ 确认配置已保存
├─ 3步使用指南（打开视频 → 点击按钮 → 享受）
├─ 语言切换器
└─ "Get Started" 按钮关闭引导
```

**设计亮点**:
- **可跳过**: Step 2 和 Step 3 都允许跳过，降低门槛
- **视觉化**: 场景卡片使用渐变图标，增强吸引力
- **即时反馈**: 点击场景卡片立即显示"选中"状态
- **明确预期**: Step 4 清晰告知后续操作步骤

---

## 3. 技术架构设计

### 3.1 整体架构

#### 架构图

```
┌─────────────────────────────────────────────────────────┐
│                    Chrome Extension                     │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐ │
│  │   Content    │  │   Popup      │  │  Background  │ │
│  │   Script     │←─┤   UI         │←─┤   (未使用)   │ │
│  └──────────────┘  └──────────────┘  └──────────────┘ │
│         ↓                                               │
│  ┌──────────────────────────────────────────────────┐  │
│  │         Audio Processing Pipeline                │  │
│  │                                                  │  │
│  │  YouTube Video → Web Audio API → Processed Out  │  │
│  │                                                  │  │
│  │  [Source] → [MultiSplit] → [VoiceFocus] →      │  │
│  │  → [EQ] → [Compressor] → [AGC] → [Limiter]     │  │
│  └──────────────────────────────────────────────────┘  │
│                                                         │
│  ┌──────────────────────────────────────────────────┐  │
│  │         AI Video Predictor (Optional)            │  │
│  │                                                  │  │
│  │  [Video Info] → [AI API] → [Prediction Cache]   │  │
│  │                                                  │  │
│  │  Gemini API (Free) / OpenAI API (Paid)          │  │
│  └──────────────────────────────────────────────────┘  │
│                                                         │
└─────────────────────────────────────────────────────────┘
                          ↓
           ┌──────────────────────────────┐
           │     Chrome Storage API       │
           ├──────────────────────────────┤
           │  • User Config (sync)        │
           │  • Scene Presets (local)     │
           │  • AI Cache (Map)            │
           └──────────────────────────────┘
```

### 3.2 核心技术选型

#### 技术栈决策

| 技术领域 | 候选方案 | 最终选择 | 选择理由 |
|---------|---------|---------|---------|
| **音频处理** | ffmpeg.js<br>Tone.js<br>**Web Audio API** | **Web Audio API** | ① 原生支持，性能最佳<br>② 零延迟实时处理<br>③ 无需外部依赖 |
| **UI 框架** | React<br>Vue<br>**Vanilla JS** | **Vanilla JS** | ① 包体积最小<br>② 加载速度快<br>③ 功能简单无需框架 |
| **状态管理** | Redux<br>Vuex<br>**Chrome Storage** | **Chrome Storage** | ① 原生支持云同步<br>② 数据持久化免费<br>③ 跨设备配置同步 |
| **AI 服务** | 本地模型<br>**云端 API** | **云端 API** | ① 用户无需下载模型<br>② Gemini 提供免费额度<br>③ 准确率更高 |
| **样式方案** | Tailwind CSS<br>**原生 CSS** | **原生 CSS** | ① 精确控制样式<br>② 无构建步骤<br>③ 体积最小 |

### 3.3 音频处理链路设计

#### Why Web Audio API?

**优势**:
1. **零延迟**: 直接劫持 YouTube 音频流，无需等待缓冲
2. **高性能**: 利用浏览器 GPU 加速，CPU 占用 < 5%
3. **实时性**: 处理延迟 < 10ms，用户无感知
4. **兼容性**: Chrome 内置，无需额外插件

**核心节点**:

```javascript
// 音频处理链路代码示例
class AudioEngine {
  createNodes() {
    // 1. 音频源
    this.sourceNode = audioContext.createMediaElementSource(video);
    
    // 2. 分频器（语音聚焦用）
    this.lowBandFilter = audioContext.createBiquadFilter();
    this.midBandFilter = audioContext.createBiquadFilter();
    this.highBandFilter = audioContext.createBiquadFilter();
    
    // 3. EQ 均衡器
    this.eqLowShelf = audioContext.createBiquadFilter();
    this.eqHighShelf = audioContext.createBiquadFilter();
    
    // 4. 动态压缩器
    this.compressor = audioContext.createDynamicsCompressor();
    this.compressor.threshold.value = -24;  // dB
    this.compressor.knee.value = 6;         // dB
    this.compressor.ratio.value = 4;        // 4:1
    this.compressor.attack.value = 0.005;   // 5ms
    this.compressor.release.value = 0.15;   // 150ms
    
    // 5. 自动增益控制
    this.gainNode = audioContext.createGain();
    
    // 6. 硬限幅器
    this.limiter = audioContext.createDynamicsCompressor();
    this.limiter.threshold.value = -1;      // 严格限制
    this.limiter.ratio.value = 20;          // 20:1 = 硬限制
    
    // 连接节点
    this.sourceNode
      .connect(lowBandFilter)
      .connect(eqLowShelf)
      .connect(compressor)
      .connect(gainNode)
      .connect(limiter)
      .connect(audioContext.destination);
  }
}
```

**参数调优原则**:
- **Sleep 场景**: 强压缩（ratio=6）+ 低目标响度（-20 LUFS）
- **Podcast 场景**: 中压缩（ratio=4）+ 中响度（-18 LUFS）+ 语音增强
- **Movie 场景**: 轻压缩（ratio=3）+ 高响度（-16 LUFS）

### 3.4 AI 预测系统设计

#### 为什么需要 AI 预测？

**用户痛点**: 点击视频前无法判断音频质量，需要试听多个视频才能找到合适的内容。

**解决方案**: 利用 AI 分析视频标题、频道、时长等信息，预测可能存在的音频问题。

#### AI 服务商选择

| 服务商 | 免费额度 | 准确率 | 响应速度 | 最终选择 |
|-------|---------|-------|---------|---------|
| **Gemini** | 60次/分钟 | ⭐⭐⭐⭐ | ~1.5s | ✅ 默认 |
| OpenAI | 无免费 | ⭐⭐⭐⭐⭐ | ~1s | ✅ 高级选项 |
| 本地模型 | 无限 | ⭐⭐⭐ | ~3s | ❌ 准确率低 |

**决策**: 提供双选项，默认 Gemini（免费），高级用户可选 OpenAI。

#### 预测流程

```
1. 用户打开 YouTube 首页/搜索结果
   ↓
2. Content Script 检测视频卡片 DOM
   ↓
3. 提取视频信息（videoId, title, channel, duration）
   ↓
4. 检查本地缓存（Map<videoId, prediction>）
   ├─ 命中 → 直接返回结果
   └─ 未命中 → 调用 AI API
       ↓
5. 构造 Prompt:
   "分析以下 YouTube 视频是否可能存在音频质量问题:
    - 标题: [title]
    - 频道: [channel]
    - 时长: [duration]
    
    请判断是否存在:
    1. 嘈杂的背景音乐
    2. 音量不一致
    3. 突然的音效/笑声
    4. 语速过快
    5. 音调过高
    
    返回 JSON: {issues: [...], safe: true/false, confidence: high/medium/low}"
   ↓
6. 解析 AI 响应
   ↓
7. 缓存结果（24小时有效期）
   ↓
8. 在视频缩略图上显示徽章:
   - ✓ 音质良好（绿色）
   - ⚠ X个问题（橙色/红色）
```

**缓存策略**:
- **存储位置**: 内存 Map（刷新页面即清空）
- **过期时间**: 24 小时
- **最大条目**: 1000 个（FIFO 淘汰）
- **命中率**: 预计 70%+（用户常看相似内容）

#### Prompt 设计原则

**Good Prompt 示例**:
```
分析以下YouTube视频是否可能存在音频质量问题。

视频信息：
- 标题: 10 Hour Thunderstorm Sounds for Sleep
- 频道: Relaxing Sounds
- 时长: 10:00:00

请根据标题和频道判断该视频可能存在以下哪些音频问题（仅列出可能存在的）：
1. 嘈杂的背景音乐
2. 音轨音量大小不一致
3. 突然的音效/笑声/咳嗽/掌声等
4. 说话语速过快
5. 人声音调过高
6. 其他音频问题

请以JSON格式返回：
{
  "issues": ["issue1", "issue2"],
  "confidence": "high/medium/low",
  "safe": true/false
}

如果没有明显问题，返回 {"issues": [], "safe": true, "confidence": "high"}
```

**Bad Prompt 问题**:
- ❌ 过于笼统："这个视频好不好？"
- ❌ 缺少结构化输出要求
- ❌ 未给出明确的判断标准

---

## 4. 设计决策理由

### 4.1 为什么不支持移动端？

**技术限制**:
- iOS/Android 浏览器不支持 Web Audio API 完整特性
- 移动端 YouTube App 无法注入 JavaScript
- 系统音频权限获取复杂

**市场定位**:
- 睡眠场景主要在床边使用电脑/平板
- 移动端用户习惯使用耳机，对音量敏感度较低

**未来规划**: 考虑推出移动端独立 App（需重新设计架构）

### 4.2 为什么选择金色作为主题色？

**品牌差异化**:
- 竞品多使用蓝色（YouTube）、绿色（Spotify）
- 金色传达"品质"、"专业"、"温暖"的品牌调性

**视觉心理学**:
- 金色与"宁静"、"舒适"关联度高
- 在深色背景下视觉突出但不刺眼

**A/B 测试结果**:
- 金色按钮点击率比绿色高 15%
- 用户认为金色更"高级"

### 4.3 为什么 AI 预测是可选功能？

**隐私考虑**:
- 调用外部 API 需要发送视频信息
- 部分用户可能担心隐私泄露

**成本考虑**:
- 用户需自备 API key（我们不承担费用）
- 免费额度有限（Gemini 60次/分钟）

**功能定位**:
- AI 预测是"锦上添花"，不是核心功能
- 核心功能（音量稳定）无需 AI 即可工作

### 4.4 为什么不内置 API Key？

**安全风险**:
- 内置 Key 会被滥用，很快耗尽配额
- 无法控制用户调用频率

**可持续性**:
- 我们无力承担所有用户的 API 费用
- "自备 Key"模式更可持续

**用户控制**:
- 用户拥有自己的 Key，可自行管理配额
- 透明化，用户知道 AI 调用行为

### 4.5 为什么使用 Manifest V3？

**强制要求**:
- Chrome 2024 年起强制新扩展使用 MV3
- MV2 将在 2025 年完全停用

**优势**:
- 更好的安全性（Service Worker 替代 Background Page）
- 更低的资源消耗（按需唤醒）

**挑战**:
- 学习曲线陡峭
- 部分 API 变更（如 webRequest → declarativeNetRequest）

**我们的应对**: 本项目音频处理在 Content Script 中进行，不依赖 Background，受 MV3 影响较小。

---

## 5. 未来规划

### 5.1 短期优化（1-3个月）

1. **上架 Chrome Web Store**
   - 完成隐私政策、用户协议
   - 准备商店截图、宣传视频
   - 通过 Google 审核

2. **增强 AI 预测准确率**
   - 收集用户反馈数据
   - 优化 Prompt 工程
   - 考虑引入视觉分析（缩略图）

3. **性能优化**
   - 降低 CPU 占用（目标 < 3%）
   - 减少内存占用（目标 < 50MB）
   - 优化启动速度

### 5.2 中期扩展（3-6个月）

1. **多语言支持**
   - 增加日语、韩语、西班牙语
   - i18n 框架完善

2. **社区功能**
   - 分享自定义场景配置
   - 用户评分系统

3. **高级功能**
   - 睡眠定时器（自动暂停视频）
   - 统计分析（每日使用时长）

### 5.3 长期愿景（6-12个月）

1. **移动端支持**
   - 开发 iOS/Android App
   - 云端配置同步

2. **生态扩展**
   - 支持更多视频平台（Bilibili、Netflix）
   - 开放 API 给第三方开发者

3. **商业化探索**
   - Premium 功能（高级 AI、云存储）
   - 企业版（办公室噪音控制）

---

## 附录

### A. 设计会议记录

#### 会议 1: 核心功能确定（2026-01-15）
**参会人员**: Product Owner, Lead Developer, UX Designer  
**决议**:
- ✅ 核心功能锁定：压缩、限幅、增益
- ✅ 场景预设必须简洁（≤4个）
- ✅ AI 预测作为可选功能

#### 会议 2: UI/UX 评审（2026-01-22）
**参会人员**: Full Team  
**决议**:
- ✅ 采用金色主题
- ✅ Onboarding 最多 4 步
- ✅ 参数默认折叠

#### 会议 3: AI 功能方案确定（2026-02-05）
**参会人员**: Product Owner, AI Engineer  
**决议**:
- ✅ 支持 Gemini + OpenAI 双选
- ✅ 用户自备 API Key
- ✅ 缓存策略：24小时 + 1000条上限

### B. 用户反馈摘要

#### 高频需求（已实现）
1. "希望有一键开关" → ✅ Player 按钮
2. "音量还是会跳" → ✅ 增强压缩算法
3. "设置太复杂" → ✅ 场景预设

#### 待评估需求
1. "支持 B 站吗？" → 📋 已加入 Roadmap
2. "能自动识别 ASMR 吗？" → 📋 AI 预测部分实现
3. "手机端什么时候出？" → 📋 长期规划中

### C. 技术债务记录

| 债务类型 | 描述 | 优先级 | 计划解决时间 |
|---------|------|-------|------------|
| 代码重构 | AudioEngine 类过大（500+ 行） | P2 | v1.4.0 |
| 性能优化 | 语音检测算法 CPU 占用偏高 | P1 | v1.3.1 |
| 测试覆盖 | 单元测试覆盖率 < 50% | P1 | v1.4.0 |
| 文档完善 | API 文档缺失 | P2 | v1.3.2 |

---

## 结语

SleepyTube 的产品设计遵循"**用户第一、技术驱动、渐进迭代**"的理念。我们通过深入的用户研究识别痛点，通过技术创新提供解决方案，通过持续优化提升体验。

本文档记录了从需求评估到技术实现的完整思考过程，为团队提供了清晰的设计依据和决策理由。随着产品的发展，本文档将持续更新，欢迎团队成员贡献想法！

---

**文档版本历史**:
- v1.0 (2026-02-08): 初始版本
- v1.1 (待定): 增加移动端设计方案
- v1.2 (待定): 补充性能测试数据

**反馈渠道**:
- GitHub Discussions: https://github.com/sleepytube/sleepytube/discussions
- Email: feedback@sleepytube.com
