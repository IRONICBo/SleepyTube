# SleepyTube 产品文档（MVP）

## 0. 背景与问题

用户睡觉时会听 YouTube，但大量内容并不“睡眠友好”，常见原因包括：

1. 背景音乐/环境音嘈杂
2. 不同片段音量大小不一致
3. 突然出现的音效/笑声/咳嗽/掌声等“爆音”
4. 语速过快
5. 人声音调过高
6. 其他（片头片尾、广告、音量极端波动、刺耳高频等）

目标：让用户 **不需要手工选片**，也能把常见视频变成“可以睡前持续听”的音频体验。

---

## 1. 需求评估方法（怎么排优先级）

### 1.1 评估维度

我们用 4 个维度给每个问题打分（1-5）：

- **出现频率**：有多少睡前内容会遇到
- **伤害程度**：对入睡的破坏性（惊醒/烦躁/持续注意）
- **可自动化程度**：是否能用算法/规则稳定解决
- **实现成本**：MVP 能否在短周期交付

最终优先级 = (频率 × 伤害 × 可自动化) / 成本

### 1.2 MVP 优先级结果

| 问题 | 频率 | 伤害 | 可自动化 | 成本 | MVP 结论 |
|---|---:|---:|---:|---:|---|
| 音量不一致 | 高 | 高 | 高 | 低 | **P0**（必须做） |
| 突然爆音（笑/掌声/音效） | 中-高 | 极高 | 中 | 中 | **P0**（必须做：先用压缩/限幅） |
| 语速过快 | 中 | 中 | 高 | 低 | **P1**（MVP 可做） |
| 声调过高 | 中 | 中 | 中 | 低 | **P1**（MVP 可做） |
| 嘈杂背景音乐/环境音 | 中 | 中 | 中-低 | 中-高 | P2（MVP 暂缓：需要更复杂降噪/分离） |
| 其他（广告、片头等） | 低-中 | 中 | 低 | 高 | P3（非 MVP） |

**因此 MVP 聚焦 3 个核心需求：**
1) 统一音量
2) 抑制突然爆音（优先用动态处理手段）
3) 可调语速/音调（帮助“听着不累”）

---

## 2. 产品形态选择（Web / Mobile）

### 2.1 目标用户流程

- 用户睡前：粘贴一个视频链接 → 点“Sleep” → 下载/播放处理后的音频
- 需求特点：**低频但关键**、临睡前操作要快、界面要极简

### 2.2 为什么先做 Web MVP

- **最短路径验证价值**：不需要上架、安装；浏览器即可用
- **后端重处理**：下载 + ffmpeg 处理，Web 形态更适合快速迭代后端算法
- **跨平台**：手机/电脑都能访问

MVP 采用：
- FastAPI 提供 API + 静态前端
- 前端不做复杂播放器，直接产出 MP3 文件（用户可用任意播放器播放/导入睡眠 App）

---

## 3. 技术架构与设计理由

### 3.1 架构概览

```
Browser (index.html)
   │  POST /api/process {url, preset, knobs}
   ▼
FastAPI backend
   │  yt-dlp: 下载音频
   │  ffmpeg: 音频滤镜链处理
   ▼
MP3 输出到 /tmp/sleepytube_outputs
   │  GET /api/download/{job_id}
   ▼
用户下载/播放
```

### 3.2 核心技术点

**(1) 统一音量：loudnorm**
- 解决：音轨音量大小不一致
- 选择理由：EBU R128 标准化方法广泛可用，ffmpeg 自带 `loudnorm`

**(2) 抑制爆音：compand + limiter**
- 解决：突然的笑声/掌声/音效等
- 选择理由：MVP 不上模型先用动态处理（压缩、软拐点、限幅）即可大幅降低“惊醒风险”

**(3) 降速与降音调：atempo + asetrate**
- 解决：语速过快、音调过高
- 选择理由：纯 ffmpeg 可实现，参数简单，用户可控

**(4) 轻度削高频：lowpass**
- 解决：夜间刺耳、sibilance
- 选择理由：简单有效，几乎无成本

### 3.3 安全与合规（MVP 范围）

- MVP 默认只处理 **单个链接**（`--no-playlist`）
- 不做账户体系、不存用户数据
- 输出文件暂存本机 `/tmp`（演示/本地部署友好）

---

## 4. MVP 范围与“不做清单”

### 4.1 已完成的需求（本 MVP）

- ✅ 音量不一致（自动统一）
- ✅ 突然爆音（压缩 + 限幅显著降低）
- ✅ 语速过快（可调慢）
- ✅ 声调过高（可调低）
- ✅ 简单 Web UI + API

### 4.2 暂不做（下一阶段）

- ⏳ 背景音乐/噪声：更高级的降噪/人声分离（例如 RNNoise、Demucs 等）
- ⏳ 精细“事件检测”并针对性削减（笑声/掌声分类）：需要模型或更复杂 DSP
- ⏳ 播放列表/批量处理与队列
- ⏳ 自动清理缓存、对象存储、鉴权与配额

---

## 5. 未来惊喜方向（Surprise Us）

如果继续做成“好用产品”，可以加：

1. **睡眠模式播放器**：直接在 Web/Mobile 端播放处理后的流，并加入定时停止、渐弱、白噪声混音。
2. **爆音智能检测**：用简单 ML（比如 VAD + transient classifier）识别 laugh/cough/clap 并做局部衰减。
3. **用户偏好学习**：根据用户常调参数自动生成个人化 preset。
4. **边下载边处理（streaming）**：减少等待时间。
